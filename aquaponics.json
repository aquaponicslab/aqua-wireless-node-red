[{"type":"tab","id":"621ad2ed.9de52c","label":"Controls"},{"type":"tab","id":"afbbe313.50442","label":"System"},{"type":"tab","id":"d3c2133e.2c3df","label":"Alerts"},{"id":"817e85f1.7e8178","type":"mqtt-broker","broker":"localhost","port":"1883"},{"id":"c9fdfb2c.360208","type":"twitter-credentials","screen_name":"@garethcoleman"},{"id":"ba386057.845d3","type":"mqtt-broker","broker":"localhost","port":"1883"},{"id":"27f39bc7.d80c64","type":"function","name":"test gate","func":"context.testing = context.testing || 0;\nif (msg.topic == \"test_this\") {\n\tcontext.testing = msg.payload;\n}\nif (msg.topic == context.testing) {\n\treturn msg;\n}\n","outputs":1,"x":486.9047546386719,"y":247.33330249786377,"z":"621ad2ed.9de52c","wires":[["fd48ba35.02b748"]]},{"id":"1810851.fe7ef7b","type":"inject","name":"Listen to Light Level","topic":"test_this","payload":"Light Level","payloadType":"string","repeat":"","crontab":"","once":false,"x":127.22727584838867,"y":34.14718437194824,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"64055119.9bfab","type":"inject","name":"STOP LISTENING","topic":"test_this","payload":"0","payloadType":"string","repeat":"","crontab":"","once":false,"x":114.41776657104492,"y":249.44479370117188,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"c1f297f2.3e0d68","type":"inject","name":"Listen to Air Temperature","topic":"test_this","payload":"Air Temperature","payloadType":"string","repeat":"","crontab":"","once":false,"x":142.22727584838867,"y":70.14718437194824,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"20726001.df8da","type":"template","name":"Lux output","template":"{{topic}}: {{payload}} lux","x":225.81251525878906,"y":345.4473571777344,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64","366ef0ed.c9911"]]},{"id":"e9bc2205.1643e","type":"template","name":"Centigrade Output","template":"{{topic}}: {{payload}} Â°C","x":276.5109100341797,"y":475.3968811035156,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64","366ef0ed.c9911"]]},{"id":"fd48ba35.02b748","type":"debug","name":"Status Data","active":true,"complete":"false","x":617.65478515625,"y":250.08336353302002,"z":"621ad2ed.9de52c","wires":[]},{"id":"2a1302ed.d5ecfe","type":"mqtt in","name":"","topic":"Light Level","broker":"817e85f1.7e8178","x":94.18685913085938,"y":350.0000352859497,"z":"621ad2ed.9de52c","wires":[["20726001.df8da"]]},{"id":"239c1059.dc63f","type":"mqtt in","name":"Air Temp","topic":"Air Temperature","broker":"817e85f1.7e8178","x":83.5,"y":463.5080261230469,"z":"621ad2ed.9de52c","wires":[["e9bc2205.1643e"]]},{"id":"d4050e5c.2bfaf","type":"mqtt in","name":"","topic":"Humidity","broker":"817e85f1.7e8178","x":96.40908813476562,"y":384.7302141189575,"z":"621ad2ed.9de52c","wires":[["57302e1f.a8cfd"]]},{"id":"97c2b529.683d48","type":"inject","name":"Listen to Humidity","topic":"test_this","payload":"Humidity","payloadType":"string","repeat":"","crontab":"","once":false,"x":116.72727966308594,"y":136.14720153808594,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"57302e1f.a8cfd","type":"template","name":"%RH Output","template":"{{topic}}: {{payload}} %RH","x":230.76623916625977,"y":384.1746406555176,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"f1f43b82.0e0bc8","type":"inject","name":"Listen to Voltage","topic":"test_this","payload":"Voltage","payloadType":"string","repeat":"","crontab":"","once":false,"x":111.72727966308594,"y":208.0836944580078,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"203716f4.dfc8ea","type":"mqtt in","name":"","topic":"Voltage","broker":"817e85f1.7e8178","x":94.85710144042969,"y":314.90915393829346,"z":"621ad2ed.9de52c","wires":[["be9afaa4.416508"]]},{"id":"b8914bde.476eb8","type":"inject","name":"Enable","topic":"","payload":"on","payloadType":"string","repeat":"","crontab":"","once":false,"x":113.75,"y":542.25,"z":"621ad2ed.9de52c","wires":[["adb75c93.5248a"]]},{"id":"318fbb78.ce7044","type":"inject","name":"Listen to pH","topic":"test_this","payload":"pH","payloadType":"string","repeat":"","crontab":"","once":false,"x":99,"y":170,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"b06ece1d.4f913","type":"mqtt in","name":"","topic":"pH","broker":"817e85f1.7e8178","x":111,"y":429,"z":"621ad2ed.9de52c","wires":[["ffad7cc4.00528"]]},{"id":"adb75c93.5248a","type":"mqtt out","name":"","topic":"Text Messaging","broker":"817e85f1.7e8178","x":376,"y":588,"z":"621ad2ed.9de52c","wires":[]},{"id":"9f21e6d1.60de18","type":"inject","name":"Disable","topic":"Text Alerts","payload":"off","payloadType":"string","repeat":"","crontab":"","once":false,"x":114,"y":584,"z":"621ad2ed.9de52c","wires":[["adb75c93.5248a"]]},{"id":"794efc0d.86b104","type":"inject","name":"Test Alert Via Light","topic":"Alert Via Light","payload":"","payloadType":"string","repeat":"","crontab":"","once":false,"x":128,"y":638,"z":"621ad2ed.9de52c","wires":[["a4ed038.f5b13"]]},{"id":"a4ed038.f5b13","type":"mqtt out","name":"","topic":"Alert Via Light","broker":"817e85f1.7e8178","x":451,"y":634,"z":"621ad2ed.9de52c","wires":[]},{"id":"c0c26e9f.3f3d9","type":"inject","name":"Test Alert Via Text","topic":"Alert Via Text","payload":"something","payloadType":"string","repeat":"","crontab":"","once":false,"x":126,"y":728,"z":"621ad2ed.9de52c","wires":[["1d22a0a9.e2dd5f"]]},{"id":"95550115.6aab","type":"mqtt out","name":"Air Temp","topic":"Air Temperature","broker":"817e85f1.7e8178","x":633,"y":338,"z":"afbbe313.50442","wires":[]},{"id":"5934c1b5.a6cb4","type":"mqtt out","name":"","topic":"Humidity","broker":"817e85f1.7e8178","x":632,"y":302,"z":"afbbe313.50442","wires":[]},{"id":"7cd65146.8329b","type":"debug","name":"Radio Monitor","active":false,"complete":"false","x":417,"y":94,"z":"afbbe313.50442","wires":[]},{"id":"95f7f784.6a0808","type":"debug","name":"System Monitor","active":true,"complete":"false","x":514,"y":38,"z":"afbbe313.50442","wires":[]},{"id":"640630a5.9bf9d","type":"inject","name":"Shutdown system","topic":"","payload":"initiated!","payloadType":"string","repeat":"","crontab":"","once":false,"x":123.90908813476562,"y":44,"z":"afbbe313.50442","wires":[["ba164f4d.45e9b"]]},{"id":"ba164f4d.45e9b","type":"exec","command":"sudo shutdown -h now && echo Shutdown","append":"","useSpawn":"","name":"Shutdown","x":313.2727355957031,"y":45.5,"z":"afbbe313.50442","wires":[["95f7f784.6a0808"],[],[]]},{"id":"d3ec0245.2c14","type":"switch","name":"","property":"sensorId","rules":[{"t":"eq","v":1,"v2":0},{"t":"eq","v":2,"v2":0},{"t":"eq","v":3,"v2":0},{"t":"eq","v":4,"v2":0}],"checkall":"true","outputs":4,"x":153,"y":342,"z":"afbbe313.50442","wires":[["6c505160.93afb"],["9caf2834.6350d8","95004574.6affb8"],["33f8a23.fcc075e"],["3aa4187a.c55be8"]]},{"id":"e019442b.1fe6b8","type":"exec","command":"/home/pi/rfm12b-linux/examples/bin/rfm12b_read","append":"","useSpawn":true,"name":"RFM12b","x":269,"y":107,"z":"afbbe313.50442","wires":[["7cd65146.8329b","ca5d83b3.35a28"],[],[]]},{"id":"138f26eb.ec70d9","type":"inject","name":"Start Receving","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":114,"y":104,"z":"afbbe313.50442","wires":[["e019442b.1fe6b8"]]},{"id":"50ab4cd7.af54b4","type":"mqtt out","name":"","topic":"Light Level","broker":"817e85f1.7e8178","x":625,"y":378,"z":"afbbe313.50442","wires":[]},{"id":"ca5d83b3.35a28","type":"function","name":"Parse Radio Data","func":"var msgString = msg.payload.toString(); \n\nif (msgString.indexOf(\"failed\") != -1) {\n\terrorMsg = {payload: msgString};\n\treturn [null, errorMsg];\n}\n\n// Fetch array from buffer\nvar rawArray = msgString.split(/\\s/);\n\nvar errorMsg = null; // will populate on error\nmsg = null; // will populate if no errors\n\n// strip off preamble and final newline\nvar dataArray = rawArray.slice(12, -2);\n\nvar nodeId = dataArray[0];\nvar numBytesExpected = dataArray[1];\nvar numBytesGot = dataArray.length - 2;\nvar sensorId = dataArray[2];\nvar readings = dataArray.slice(4);\n\n// check integrity\nif (nodeId > 32) {\n\terrorMsg = {payload: 'Invalid Node Id: ' + nodeId}; \n} else if (sensorId > 15) {\n\terrorMsg = {payload: 'Invalid Sensor Id: ' + sensorId};\n} else if (numBytesExpected != numBytesGot) {\n\terrorMsg = {payload: 'Expected ' + numBytesExpected + ' bytes, got ' + numBytesGot};\n} else {\n\tmsg = {\n\t\tnodeId: nodeId,\n\t\tsensorId: sensorId,\n\t\treadings: readings\n\t}\n}\n\nreturn [msg, errorMsg];","outputs":"2","x":352.5,"y":161,"z":"afbbe313.50442","wires":[["d3c1fbde.2c3e08"],["e6b2ea90.194d18"]]},{"id":"d3c1fbde.2c3e08","type":"function","name":"Calculate readings","func":"// Array contains two readings, each occupying 2\n// elements (bytes).\n\nvar MSB = msg.readings.pop();\nvar LSB = msg.readings.pop(); \nvar secondReading = 256* parseFloat(MSB)+ parseFloat(LSB);\n\nvar MSB = msg.readings.pop();\nvar LSB = msg.readings.pop(); \nvar firstReading = 256* parseFloat(MSB)+ parseFloat(LSB);\n\nmsg.firstReading = firstReading\nmsg.secondReading = secondReading;\n\nreturn msg;","outputs":"1","x":186,"y":227,"z":"afbbe313.50442","wires":[["d3ec0245.2c14"]]},{"id":"8653f6c.f79ac08","type":"mqtt out","name":"","topic":"Voltage","broker":"817e85f1.7e8178","x":633,"y":267,"z":"afbbe313.50442","wires":[]},{"id":"be9afaa4.416508","type":"template","name":"Volts output","template":"Battery Level: {{payload}} V","x":237,"y":306,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64","366ef0ed.c9911"]]},{"id":"ffad7cc4.00528","type":"template","name":"pH output","template":"{{topic}}: {{payload}}","x":250,"y":422,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"e6b2ea90.194d18","type":"debug","name":"Bad Radio","active":true,"complete":"false","x":511,"y":198,"z":"afbbe313.50442","wires":[]},{"id":"9caf2834.6350d8","type":"function","name":"Scale Air Temp","func":"/* \n\tRaw temperature reading is ten times too big\n*/\n\nvar temp = msg.secondReading;\nmsg.payload = temp / 10;\n\n\nreturn msg;","outputs":1,"x":409,"y":349,"z":"afbbe313.50442","wires":[["95550115.6aab"]]},{"id":"6c505160.93afb","type":"function","name":"Scale Voltage","func":"/* \n    1023 steps, 4.5 max voltage\n*/\n\nvar rawReading = msg.firstReading;\nvar voltsFloat = rawReading / 1023 * 5.16; \nmsg.payload = voltsFloat.toFixed(2);\nreturn msg;","outputs":1,"x":420,"y":263,"z":"afbbe313.50442","wires":[["8653f6c.f79ac08"]]},{"id":"95004574.6affb8","type":"function","name":"Scale Humdity","func":"msg.payload = msg.firstReading;\nreturn msg;","outputs":1,"x":406,"y":307,"z":"afbbe313.50442","wires":[["5934c1b5.a6cb4"]]},{"id":"33f8a23.fcc075e","type":"function","name":"Parse Light","func":"msg.payload = msg.firstReading;\nreturn msg;","outputs":"1","x":400,"y":399,"z":"afbbe313.50442","wires":[["50ab4cd7.af54b4"]]},{"id":"3aa4187a.c55be8","type":"function","name":"Scale Water Temp","func":"msg.payload = msg.firstReading / 10;\n\nreturn msg;","outputs":1,"x":415,"y":450,"z":"afbbe313.50442","wires":[["6d959071.926a7"]]},{"id":"6d959071.926a7","type":"mqtt out","name":"Water Temp","topic":"Water Temperature","broker":"817e85f1.7e8178","x":624,"y":448,"z":"afbbe313.50442","wires":[]},{"id":"69fda18.f96026","type":"inject","name":"Listen to Water Temperature","topic":"test_this","payload":"Water Temperature","payloadType":"string","repeat":"","crontab":"","once":false,"x":151,"y":103,"z":"621ad2ed.9de52c","wires":[["27f39bc7.d80c64"]]},{"id":"b9cd4552.4632b8","type":"mqtt in","name":"Water Temp","topic":"Water Temperature","broker":"817e85f1.7e8178","x":96,"y":501,"z":"621ad2ed.9de52c","wires":[["e9bc2205.1643e"]]},{"id":"27a11de5.d85ee2","type":"mqtt in","name":"","topic":"Water Temperature","broker":"817e85f1.7e8178","x":94,"y":125,"z":"d3c2133e.2c3df","wires":[["e60c1dc8.19f3e"]]},{"id":"e60c1dc8.19f3e","type":"function","name":"Too hot?","func":"/* \n\tRaise alarm when necessary\n*/\nif (msg.payload > 28) {\n\tmsg.payload = \"hot\";\n\treturn msg;\n}\n","outputs":1,"x":308.77777099609375,"y":124.49200439453125,"z":"d3c2133e.2c3df","wires":[["16c8f4c4.e9370b","60437b9a.9fbc84"]]},{"id":"8998c7e5.766738","type":"mqtt in","name":"","topic":"Alert Via Light","broker":"817e85f1.7e8178","x":142.77777099609375,"y":500.49200439453125,"z":"d3c2133e.2c3df","wires":[["7cb991e6.83467","ef3831bb.10c7d"]]},{"id":"db9971a3.24669","type":"file","name":"Send Text Message","filename":"/var/spool/gammu/outbox/OUT07968915496.txt","appendNewline":false,"overwriteFile":false,"x":615.25,"y":635.5,"z":"d3c2133e.2c3df","wires":[]},{"id":"578189b8.a87e78","type":"function","name":"Too dark?","func":"/* \n\tRaise alarm when necessary\n*/\nif (msg.payload < 10) {\n\tmsg.payload = \"dark\";\n\treturn msg;\n}","outputs":1,"x":214,"y":300,"z":"d3c2133e.2c3df","wires":[[]]},{"id":"27626dd0.d89d92","type":"function","name":"Manage texts","func":"var msg, textMsg;\ncontext.textEnabled = context.textEnabled || 'Off'\n\n// turn text messaging on or off\nif (msg.topic == 'Text Messaging') {\n\tcontext.textEnabled = msg.payload;\n\tmsg.payload = 'Text Messaging ' + msg.payload;\n}\n\n// raise an alert\nif (msg.topic == 'Alert Via Text') {\n\tmsg.payload = 'Help! hey man its getting too ' + msg.payload + '!';\n\tif (context.textEnabled == 'on') {\n\t\ttextMsg = msg;\n\t}\n}\n\nreturn [msg, textMsg];","outputs":"2","x":395,"y":614,"z":"d3c2133e.2c3df","wires":[["f0535798.0faca8"],["db9971a3.24669","6fafaaa1.905054"]]},{"id":"e88355f2.177ca8","type":"mqtt in","name":"Enable or Disable Text Messaging","topic":"Text Messaging","broker":"817e85f1.7e8178","x":153,"y":624,"z":"d3c2133e.2c3df","wires":[["27626dd0.d89d92"]]},{"id":"7cb991e6.83467","type":"exec","command":"/home/pi/rcswitch-pi/send 4 4 1","append":"","useSpawn":"","name":"Big light on","x":348,"y":540,"z":"d3c2133e.2c3df","wires":[["80ee8eed.7f117"],[],[]]},{"id":"d1ed67d1.2e1298","type":"exec","command":"/home/pi/rcswitch-pi/send 4 4 0","append":"","useSpawn":"","name":"Big light off","x":642,"y":546,"z":"d3c2133e.2c3df","wires":[[],[],[]]},{"id":"cf83f19a.307c1","type":"exec","command":"/home/pi/rcswitch-pi/send 4 4 1","append":"","useSpawn":"","name":"Big light on","x":700,"y":672,"z":"afbbe313.50442","wires":[[],[],[]]},{"id":"2208f519.ddf70a","type":"exec","command":"/home/pi/rcswitch-pi/send 4 4 0","append":"","useSpawn":"","name":"Big light off","x":703,"y":587,"z":"afbbe313.50442","wires":[[],[],[]]},{"id":"56e41f8a.a91be","type":"mqtt in","name":"","topic":"Light Level","broker":"817e85f1.7e8178","x":215,"y":583,"z":"afbbe313.50442","wires":[["31e119dd.ce1ee6"]]},{"id":"31e119dd.ce1ee6","type":"switch","name":"","property":"payload","rules":[{"t":"gte","v":5,"v2":0},{"t":"lt","v":5,"v2":0}],"checkall":"false","outputs":2,"x":416,"y":583,"z":"afbbe313.50442","wires":[["2208f519.ddf70a"],["cf83f19a.307c1"]]},{"id":"80ee8eed.7f117","type":"delay","name":"","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":492,"y":537,"z":"d3c2133e.2c3df","wires":[["d1ed67d1.2e1298"]]},{"id":"860f011.f79f1","type":"mqtt in","name":"","topic":"Alert Via Text","broker":"817e85f1.7e8178","x":154,"y":581,"z":"d3c2133e.2c3df","wires":[["27626dd0.d89d92"]]},{"id":"f0535798.0faca8","type":"debug","name":"Text monitor","active":true,"complete":"false","x":584,"y":594,"z":"d3c2133e.2c3df","wires":[]},{"id":"16c8f4c4.e9370b","type":"mqtt out","name":"","topic":"Alert Via Light","broker":"817e85f1.7e8178","x":477,"y":203,"z":"d3c2133e.2c3df","wires":[]},{"id":"34e48b27.cb1b74","type":"mqtt in","name":"","topic":"Light Level","broker":"817e85f1.7e8178","x":57,"y":296,"z":"d3c2133e.2c3df","wires":[["578189b8.a87e78"]]},{"id":"60437b9a.9fbc84","type":"mqtt out","name":"","topic":"Alert Via Text","broker":"817e85f1.7e8178","x":485,"y":121,"z":"d3c2133e.2c3df","wires":[]},{"id":"1d22a0a9.e2dd5f","type":"mqtt out","name":"","topic":"Alert Via Text","broker":"817e85f1.7e8178","x":453,"y":719,"z":"621ad2ed.9de52c","wires":[]},{"id":"ef3831bb.10c7d","type":"debug","name":"Alert-via-light monitor","active":true,"complete":"false","x":368,"y":464,"z":"d3c2133e.2c3df","wires":[]},{"id":"63d3bb76.9c2c44","type":"mqtt out","name":"","topic":"Text Messaging","broker":"817e85f1.7e8178","x":542,"y":764,"z":"d3c2133e.2c3df","wires":[]},{"id":"6fafaaa1.905054","type":"template","name":"Disable","template":"off","x":316,"y":707,"z":"d3c2133e.2c3df","wires":[["63d3bb76.9c2c44","f624f5c8.09db08"]]},{"id":"f624f5c8.09db08","type":"delay","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":320,"y":770,"z":"d3c2133e.2c3df","wires":[["5ec7af48.a1385"]]},{"id":"5ec7af48.a1385","type":"template","name":"Re-enable","template":"on","x":314,"y":828,"z":"d3c2133e.2c3df","wires":[["63d3bb76.9c2c44"]]},{"id":"366ef0ed.c9911","type":"function","name":"Light WTemp Batt Report","func":"context.light = context.light || \"\";\ncontext.wtemp = context.wtemp || \"\";\ncontext.batt = context.batt || \"\";\n\nif (msg.topic == \"Water Temperature\") {\n\tcontext.wtemp = msg.payload;\n\treturn null;\n} else if (msg.topic == \"Light Level\"){\n\tcontext.light = msg.payload;\n\treturn null;\n} else if (msg.topic == \"Voltage\") {\n\tcontext.batt = msg.payload;\n\treturn null;\n} else if (msg.topic == \"Daily Report\") {\n\tvar currentdate = new Date();\n\n    msg.time = currentdate.getHours() + \":\" + currentdate.getMinutes();\n\tmsg.batt = context.batt;\n\tmsg.light = context.light;\n\tmsg.wtemp = context.wtemp;\n\treturn msg;\n}\n\nreturn msg;","outputs":1,"x":492,"y":367,"z":"621ad2ed.9de52c","wires":[["6dbe79c5.924188"]]},{"id":"68bf0964.9740f8","type":"inject","name":"Daily Report","topic":"Daily Report","payload":"","payloadType":"date","repeat":"","crontab":"00 18 * * *","once":false,"x":313,"y":530,"z":"621ad2ed.9de52c","wires":[["366ef0ed.c9911"]]},{"id":"6dbe79c5.924188","type":"template","name":"Report template","template":"Daily Report: The state of the system at {{time}} is as follows. {{wtemp}},  {{light}},  {{batt}}","x":541,"y":438,"z":"621ad2ed.9de52c","wires":[["29c9e4b8.d6361c"]]},{"id":"7cc9fd21.833604","type":"file","name":"Send Text Message","filename":"/var/spool/gammu/outbox/OUT07968915496.txt","appendNewline":false,"overwriteFile":false,"x":527,"y":498,"z":"621ad2ed.9de52c","wires":[]},{"id":"29c9e4b8.d6361c","type":"debug","name":"","active":true,"console":false,"complete":false,"x":533,"y":558,"z":"621ad2ed.9de52c","wires":[]}]